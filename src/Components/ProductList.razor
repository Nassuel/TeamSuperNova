@using ContosoCrafts.WebSite.Enums
@using ContosoCrafts.WebSite.Models
@using ContosoCrafts.WebSite.Services
@using Microsoft.AspNetCore.Components.Web
@inject JsonFileProductService ProductService

<!-- Search and Filter Input Section -->
<div class="container mb-4">
    <div class="row">
        <!-- Search Box -->
        <div class="col-md-12 mb-3">
            <input type="text"
                   class="form-control theme-input"
                   placeholder="Search Brands..."
                   @bind="SearchTerm" />
        </div>
    </div>
    <div class="row">
        <!-- Product Type Filter - DYNAMICALLY POPULATED -->
        <div class="col-md-3 mb-2">
            <label class="col-form-label theme-label">Product Type</label>
            <select class="form-control theme-input" @bind="SelectedProductType">
                <option value="">All Types</option>
                @foreach (var productType in GetAllProductTypes())
                {
                    <option value="@productType">@productType.DisplayName()</option>
                }
            </select>
        </div>
        <!-- Brand Filter - DYNAMICALLY POPULATED -->
        <div class="col-md-3 mb-2">
            <label class="col-form-label theme-label">Brand</label>
            <select class="form-control theme-input" @bind="SelectedBrand">
                <option value="">All Brands</option>
                @foreach (var brand in GetAllBrands())
                {
                    <option value="@brand">@brand</option>
                }
            </select>
        </div>
        <!-- Min Rating Filter -->
        <div class="col-md-2 mb-2">
            <label class="col-form-label theme-label">Min Rating</label>
            <select class="form-control theme-input" @bind="MinRating">
                <option value="0">All Ratings</option>
                <option value="1">1+ Stars</option>
                <option value="2">2+ Stars</option>
                <option value="3">3+ Stars</option>
                <option value="4">4+ Stars</option>
                <option value="5">5 Stars</option>
            </select>
        </div>
        <!-- Sort By -->
        <div class="col-md-2 mb-2">
            <label class="col-form-label theme-label">Sort By</label>
            <select class="form-control theme-input" @bind="SortBy">
                <option value="">Default</option>
                <option value="BrandAZ">Brand: A-Z</option>
                <option value="BrandZA">Brand: Z-A</option>
                <option value="RatingHighLow">Rating: High-Low</option>
                <option value="RatingLowHigh">Rating: Low-High</option>
            </select>
        </div>
        <!-- Clear Filters Button -->
        <div class="col-md-2 mb-2 d-flex align-items-end">
            <button class="btn btn-secondary w-100 theme-btn-secondary" @onclick="ClearFilters">Clear All</button>
        </div>
    </div>
</div>

<BlazorAnimate.Animate Animation="BlazorAnimate.Animations.FadeUp" Duration="TimeSpan.FromSeconds(0.5)">
    <div class="card-columns">
        @foreach (var product in CurrentProductList)
        {
            <div class="card theme-card">
                <div class="card-img" style="background-image: url('@product.Image');">
                </div>
                <div class="card-body theme-card-body">
                    <h4 class="card-title theme-card-title">@product.Brand</h4>
                    <h6 class="card-subtitle theme-card-subtitle">@(product.ProductType.DisplayName())</h6>
                </div>
                <div class="card-footer theme-card-footer">
                    <small>
                        <button @onclick="(e => SelectProduct(product.Id))"
                                data-toggle="modal" data-target="#productModal" class="btn btn-primary theme-btn-primary">
                            More Info
                        </button>
                    </small>
                </div>
            </div>
        }
    </div>
</BlazorAnimate.Animate>

@if (CurrentProductList.Count() == 0)
{
    <div class="alert theme-alert text-center mt-4" role="alert">
        No products are found which matches your filters. Try adjusting your search criteria.
    </div>
}

@if (SelectedProduct != null)
{
    <div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content theme-modal-content">
                <div class="modal-header theme-modal-header">
                    <h5 class="modal-title theme-modal-title" id="productTitle">@SelectedProduct.Brand</h5>
                    <button type="button" class="close theme-close-btn" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body theme-modal-body">
                    <!-- Main card body -->
                    <div class="card theme-card">
                        <div class="card-img" style="background-image: url('@SelectedProduct.Image');">
                        </div>
                        <div class="card-body theme-card-body">
                            <p class="card-text theme-card-text">@SelectedProduct.ProductDescription</p>
                        </div>
                    </div>

                    <!-- Comments -->
                    <hr class="theme-hr" />
                    <div class="row">
                        <div class="col">
                            <h5 class="theme-heading">
                                <i class="fa fa-commenting-o mr-2" aria-hidden="true"></i>
                                Comments
                            </h5>
                        </div>
                    </div>

                    @if (HasComments())
                    {
                        <ul class="list-unstyled mb-4">
                            @foreach (var comment in SelectedProduct.CommentList)
                            {
                                <li class="list-group-item theme-list-item pb-2">
                                    <small class="theme-text-muted">
                                        @(comment.CreatedAt.ToShortDateString() + " " + comment.CreatedAt.ToShortTimeString())
                                    </small>
                                    <br />
                                    <span class="theme-text">@comment.Comment</span>
                                </li>
                            }
                        </ul>
                    }

                    @if (SelectedProduct.CommentList == null)
                    {
                        <p class="theme-text">No comments yet — be the first!</p>
                    }
                </div>

                <div class="modal-footer theme-modal-footer">
                    <textarea class="form-control theme-input"
                              @bind="NewComment"
                              placeholder="Type your comment..."
                              rows="2"
                              @onkeydown="@(e => UsingEnterKey(e))">
                        </textarea>

                    <button class="btn btn-primary mt-2 theme-btn-primary" @onclick="AddComment">Submit Comment</button>
                </div>
                <div class="modal-footer theme-modal-footer justify-content-between">
                    @if (string.IsNullOrEmpty(SelectedProduct.Url) == false)
                    {
                        <a href="@SelectedProduct.Url" target="_blank" class="btn btn-primary theme-btn-primary">View Product</a>
                    }

                    <!-- Ratings -->
                    @if (VoteCount == 0)
                    {
                        <span class="theme-text">Be the first to vote!</span>
                    }

                    @if (VoteCount > 0)
                    {
                        <span class="theme-text">@VoteCount @VoteLabel</span>
                    }

                    @for (int i = 1; i < 6; i++)
                    {
                        var currentStar = i;

                        if (i <= CurrentRating)
                        {
                            <span class="fa fa-star checked" @onclick="(e => SubmitRating(currentStar))"></span>
                        }

                        if (i > CurrentRating)
                        {
                            <span class="fa fa-star theme-star" @onclick="(e => SubmitRating(currentStar))"></span>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



@code
{

    // Search term entered by user for filtering products
    string SearchTerm = string.Empty;

    // Selected product type filter value
    string SelectedProductType = string.Empty;

    // Selected brand filter value
    string SelectedBrand = string.Empty;

    // Minimum rating filter value
    int MinRating = 0;

    // Sort order selection
    string SortBy = string.Empty;

    // Currently selected product for modal display
    ProductModel SelectedProduct;

    // ID of the selected product
    string SelectedProductId;

    // Current average rating of selected product
    int CurrentRating = 0;

    // Total number of votes for selected product
    int VoteCount = 0;

    // Label text for vote count display
    string VoteLabel;

    // Text of the new comment being added
    string NewComment = string.Empty;

    /// <summary>
    /// Returns filtered and sorted product list based on current filter criteria
    /// </summary>
    IEnumerable<ProductModel> CurrentProductList
    {
        get
        {

            // Get all products from service
            var products = ProductService.GetProducts();

            // Apply search filter
            products = ApplySearchFilter(products);

            // Apply product type filter
            products = ApplyProductTypeFilter(products);

            // Apply brand filter
            products = ApplyBrandFilter(products);

            // Apply rating filter
            products = ApplyRatingFilter(products);

            // Apply sorting
            products = ApplySorting(products);

            return products;

        }
    }

    /// <summary>
    /// Gets all ProductType enum values excluding Undefined
    /// </summary>
    /// <returns>Collection of all product types</returns>
    IEnumerable<ProductTypeEnum> GetAllProductTypes()
    {

        // Get all enum values and filter out Undefined
        return Enum.GetValues<ProductTypeEnum>()
            .Where(pt => pt != ProductTypeEnum.Undefined)
            .OrderBy(pt => pt.DisplayName());

    }

    /// <summary>
    /// Gets all unique brands from the product catalog
    /// </summary>
    /// <returns>Collection of unique brand names</returns>
    IEnumerable<string> GetAllBrands()
    {

        // Get all products, extract brands, remove duplicates, and sort
        return ProductService.GetProducts()
            .Select(p => p.Brand)
            .Distinct()
            .OrderBy(b => b);

    }

    /// <summary>
    /// Selects a product and loads its details for modal display
    /// </summary>
    /// <param name="productId">ID of the product to select</param>
    void SelectProduct(string productId)
    {

        // Store the selected product ID
        SelectedProductId = productId;

        // Retrieve the product from service
        SelectedProduct = ProductService.GetProducts().First(x => x.Id == productId);

        // Calculate current rating
        GetCurrentRating();

    }

    /// <summary>
    /// Calculates and updates the current rating for the selected product
    /// </summary>
    void GetCurrentRating()
    {

        // Fast fail: Check if ratings array is null
        if (SelectedProduct.Ratings == null)
        {
            CurrentRating = 0;
            VoteCount = 0;
            return;
        }

        // Count total votes
        VoteCount = SelectedProduct.Ratings.Count();

        // Set appropriate vote label
        VoteLabel = "Vote";

        if (VoteCount > 1)
        {
            VoteLabel = "Votes";
        }

        // Calculate average rating
        CurrentRating = SelectedProduct.Ratings.Sum() / VoteCount;

        System.Console.WriteLine($"Current rating for {SelectedProduct.Id}: {CurrentRating}");

    }

    /// <summary>
    /// Submits a new rating for the selected product
    /// </summary>
    /// <param name="rating">Rating value to submit</param>
    void SubmitRating(int rating)
    {

        System.Console.WriteLine($"Rating received for {SelectedProduct.Id}: {rating}");

        // Add rating to product
        ProductService.AddRating(SelectedProductId, rating);

        // Refresh selected product data
        SelectProduct(SelectedProductId);

    }

    /// <summary>
    /// Clears all filter and search criteria
    /// </summary>
    void ClearFilters()
    {

        // Reset search term
        SearchTerm = string.Empty;

        // Reset product type filter
        SelectedProductType = string.Empty;

        // Reset brand filter
        SelectedBrand = string.Empty;

        // Reset rating filter
        MinRating = 0;

        // Reset sort order
        SortBy = string.Empty;

    }

    /// <summary>
    /// Applies search term filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplySearchFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if search term is empty
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            return products;
        }

        // Filter products by brand name containing search term
        return products.Where(p =>
            p.Brand.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    }

    /// <summary>
    /// Applies product type filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplyProductTypeFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if product type filter is empty
        if (string.IsNullOrWhiteSpace(SelectedProductType))
        {
            return products;
        }

        // Try to parse selected product type
        var parseSuccessful = Enum.TryParse<ProductTypeEnum>(SelectedProductType, out var productTypeEnum);

        // Fast fail: Check if parse was unsuccessful
        if (parseSuccessful == false)
        {
            return products;
        }

        // Filter products by product type
        return products.Where(p => p.ProductType == productTypeEnum);

    }

    /// <summary>
    /// Applies brand filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplyBrandFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if brand filter is empty
        if (string.IsNullOrWhiteSpace(SelectedBrand))
        {
            return products;
        }

        // Filter products by exact brand match
        return products.Where(p =>
            p.Brand.Equals(SelectedBrand, StringComparison.OrdinalIgnoreCase));

    }

    /// <summary>
    /// Applies minimum rating filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplyRatingFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if no rating filter is applied
        if (MinRating == 0)
        {
            return products;
        }

        // Filter products by minimum average rating
        return products.Where(p =>
        {

            // Fast fail: Check if product has no ratings
            if (p.Ratings == null)
            {
                return false;
            }

            if (p.Ratings.Length == 0)
            {
                return false;
            }

            // Calculate average rating
            var avgRating = p.Ratings.Sum() / p.Ratings.Length;

            // Check if average meets minimum
            return avgRating >= MinRating;

        });

    }

    /// <summary>
    /// Applies sorting to product list based on sort criteria
    /// </summary>
    /// <param name="products">Products to sort</param>
    /// <returns>Sorted product list</returns>
    IEnumerable<ProductModel> ApplySorting(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if no sorting is selected
        if (string.IsNullOrWhiteSpace(SortBy))
        {
            return products;
        }

        // Fast fail: Check if sorting by Brand A-Z
        if (SortBy == "BrandAZ")
        {
            return products.OrderBy(p => p.Brand);
        }

        // Fast fail: Check if sorting by Brand Z-A
        if (SortBy == "BrandZA")
        {
            return products.OrderByDescending(p => p.Brand);
        }

        // Fast fail: Check if sorting by Rating High to Low
        if (SortBy == "RatingHighLow")
        {
            return products.OrderByDescending(p => GetAverageRating(p));
        }

        // Fast fail: Check if sorting by Rating Low to High
        if (SortBy == "RatingLowHigh")
        {
            return products.OrderBy(p => GetAverageRating(p));
        }

        // Return unsorted if sort option not recognized
        return products;

    }

    /// <summary>
    /// Calculates the average rating for a product
    /// </summary>
    /// <param name="product">Product to calculate rating for</param>
    /// <returns>Average rating or 0 if no ratings exist</returns>
    int GetAverageRating(ProductModel product)
    {

        // Fast fail: Check if ratings is null
        if (product.Ratings == null)
        {
            return 0;
        }

        // Fast fail: Check if ratings array is empty
        if (product.Ratings.Length == 0)
        {
            return 0;
        }

        // Calculate and return average rating
        return product.Ratings.Sum() / product.Ratings.Length;

    }

    /// <summary>
    /// Save comment to the data store
    /// </summary>
    async Task<bool> AddComment()
    {
        // Fast fail: Check if new comment text is empty
        if (string.IsNullOrWhiteSpace(NewComment))
        {
            return false;
        }

        // Add the new comment to the selected product
        ProductService.AddCommentToProduct(SelectedProductId, new CommentModel() { Comment = NewComment });

        // Hide the new comment input box
        NewComment = "";

        // UI Refresh
        StateHasChanged();

        return true;

    }

    /// <summary>
    /// Checks for Enter key press to submit comment
    /// </summary>
    /// <param name="e"></param>
    public void UsingEnterKey(KeyboardEventArgs e)
    {
        // Fast fail: Check if key is not Enter
        if (e.Key != "Enter")
        {
            return;
        }

        // Fast fail: Check if Shift key is pressed
        if (e.ShiftKey == true)
        {
            return;
        }

        // Submit the comment
        AddComment();
    }

    /// <summary>
    /// Checks if the selected product has any comments
    /// </summary>
    /// <returns>True if comments exist, false otherwise</returns>
    bool HasComments()
    {

        // Fast fail: Check if comment list is null
        if (SelectedProduct.CommentList == null)
        {
            return false;
        }

        // Fast fail: Check if comment list is empty
        if (SelectedProduct.CommentList.Any() == false)
        {
            return false;
        }

        return true;

    }

}