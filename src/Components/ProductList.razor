@using ContosoCrafts.WebSite.Enums;
@using ContosoCrafts.WebSite.Models;
@using ContosoCrafts.WebSite.Services;
@using Microsoft.AspNetCore.Components.Web;
@using Microsoft.JSInterop;
@inject NavigationManager NavigationManager;
@inject IJSRuntime JSRuntime;
@inject JsonFileProductService ProductService;

<!-- Search and Filter Input Section -->
<div class="container mb-4">
    <div class="row">
        <!-- Search Box -->
        <div class="col-md-12 mb-3">
            <div class="d-flex align-content-center">
            <input type="text"
                   class="form-control theme-input"
                   placeholder="Search Brands..."
                   @bind-value="SearchTerm"
                   @bind-value:event="oninput" />
            @if (string.IsNullOrWhiteSpace(SearchTerm) == false)
                {
                    <button class="btn btn-secondary theme-btn-secondary ml-2"
                            type="button"
                            @onclick="ClearSearch"
                            title="Clear search">
                        <span aria-hidden="true">&times;</span>
                    </button>
                }
            </div>
        </div>
    </div>
    <div class="row">
        <!-- Product Type Filter - DYNAMICALLY POPULATED -->
        <div class="col-md-3 mb-2">
            <label class="col-form-label theme-label">Product Type</label>
            <select class="form-control theme-input" @bind="SelectedProductType">
                <option value="">All Types</option>
                @foreach (var productType in GetAllProductTypes())
                {
                    <option value="@productType">@productType.DisplayName()</option>
                }
            </select>
        </div>
        <!-- Brand Filter - DYNAMICALLY POPULATED -->
        <div class="col-md-3 mb-2">
            <label class="col-form-label theme-label">Brand</label>
            <select class="form-control theme-input" @bind="SelectedBrand">
                <option value="">All Brands</option>
                @foreach (var brand in GetAllBrands())
                {
                    <option value="@brand">@brand</option>
                }
            </select>
        </div>
        <!-- Min Rating Filter -->
        <div class="col-md-2 mb-2">
            <label class="col-form-label theme-label">Min Rating</label>
            <select class="form-control theme-input" @bind="MinRating">
                <option value="0">All Ratings</option>
                <option value="1">1+ Stars</option>
                <option value="2">2+ Stars</option>
                <option value="3">3+ Stars</option>
                <option value="4">4+ Stars</option>
                <option value="5">5 Stars</option>
            </select>
        </div>
        <!-- Sort By -->
        <div class="col-md-2 mb-2">
            <label class="col-form-label theme-label">Sort By</label>
            <select class="form-control theme-input" @bind="SortBy">
                <option value="">Default</option>
                <option value="BrandAZ">Brand: A-Z</option>
                <option value="BrandZA">Brand: Z-A</option>
                <option value="RatingHighLow">Rating: High-Low</option>
                <option value="RatingLowHigh">Rating: Low-High</option>
            </select>
        </div>
        <!-- Clear Filters Button -->
        <div class="col-md-2 mb-2 d-flex align-items-end">
            <button class="btn btn-secondary w-100 theme-btn-secondary" @onclick="ClearFilters">Clear All</button>
        </div>
    </div>
</div>

<BlazorAnimate.Animate Animation="BlazorAnimate.Animations.FadeUp" Duration="TimeSpan.FromSeconds(0.5)">
    <div class="card-columns">
        @foreach (var product in CurrentProductList)
        {
            <div class="card theme-card">
                <div class="card-img" style="background-image: url('@product.Image');">
                </div>
                <div class="card-body theme-card-body">
                    <h4 class="card-title theme-card-title">@((MarkupString)HighlightMatch(product.Brand))</h4>
                    <h6 class="card-subtitle theme-card-subtitle">@(product.ProductType.DisplayName())</h6>
                </div>
                <div class="card-footer theme-card-footer">
                    <small>
                        <button @onclick="(e => SelectProduct(product.Id))"
                                class="btn btn-primary theme-btn-primary">
                            More Info
                        </button>
                    </small>
                </div>
            </div>
        }
    </div>
</BlazorAnimate.Animate>

@if (CurrentProductList.Count() == 0)
{
    <div class="alert theme-alert text-center mt-4" role="alert">
        No products are found which matches your filters. Try adjusting your search criteria.
    </div>
}

@if (SelectedProduct is not null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog" aria-labelledby="productTitle">
        <div class="modal-dialog modal-dialog-scrollable" role="document">
            <div class="modal-content theme-modal-content">
                <div class="modal-header theme-modal-header">
                    <h5 class="modal-title theme-modal-title" id="productTitle">@SelectedProduct.Brand</h5>
                    <div class="ml-auto d-flex align-items-center">
                        @* Share button *@
                        <button type="button"
                                class="btn btn-sm theme-share-btn mr-2"
                                @onclick="CopyShareLink"
                                title="Copy share link">
                            <i class="fa fa-share-alt" aria-hidden="true"></i>
                        </button>
                        @* Close button *@
                        <button type="button" class="close theme-close-btn" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
                <div class="modal-body theme-modal-body">
                    <!-- Main card body -->
                    <div class="card theme-card">
                        <div class="card-img" style="background-image: url('@SelectedProduct.Image');">
                        </div>
                        <div class="card-body theme-card-body">
                            <p class="card-text theme-card-text">@SelectedProduct.ProductDescription</p>
                        </div>
                    </div>

                    <!-- Comments -->
                    <hr class="theme-hr" />
                    <div class="row">
                        <div class="col">
                            <h5 class="theme-heading">
                                <i class="fa fa-commenting-o mr-2" aria-hidden="true"></i>
                                Comments
                            </h5>
                        </div>
                    </div>

                    @if (HasComments())
                    {
                        <ul class="list-unstyled mb-4">
                            @foreach (var comment in SelectedProduct.CommentList)
                            {
                                <li class="list-group-item theme-list-item pb-2">
                                    <small class="theme-text-muted">
                                        @(comment.CreatedAt.ToShortDateString() + " " + comment.CreatedAt.ToShortTimeString())
                                    </small>
                                    <br />
                                    <span class="theme-text">@comment.Comment</span>
                                </li>
                            }
                        </ul>
                    }

                    @if (SelectedProduct.CommentList == null)
                    {
                        <p class="theme-text">No comments yet — be the first!</p>
                    }
                </div>

                <div class="modal-footer theme-modal-footer">
                    <textarea class="form-control theme-input"
                              @bind="NewComment"
                              placeholder="Type your comment..."
                              rows="2"
                              @onkeydown="@(e => UsingEnterKey(e))">
                        </textarea>

                    <button class="btn btn-primary theme-btn-primary" @onclick="AddComment">Submit Comment</button>
                </div>
                <div class="modal-footer theme-modal-footer justify-content-between">
                    @if (string.IsNullOrEmpty(SelectedProduct.Url) == false)
                    {
                        <a href="@SelectedProduct.Url" target="_blank" class="btn btn-primary theme-btn-primary">View Product</a>
                    }

                    <!-- Ratings -->
                    @if (VoteCount == 0)
                    {
                        <span class="theme-text">Be the first to vote!</span>
                    }

                    @if (VoteCount > 0)
                    {
                        <span class="theme-text">@VoteCount @VoteLabel</span>
                    }

                    @for (int i = 1; i < 6; i++)
                    {
                        var currentStar = i;

                        if (i <= CurrentRating)
                        {
                            <span class="fa fa-star checked" @onclick="(e => SubmitRating(currentStar))"></span>
                        }

                        if (i > CurrentRating)
                        {
                            <span class="fa fa-star theme-star" @onclick="(e => SubmitRating(currentStar))"></span>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Copy Link Toast -->
@if (ShowCopyToast)
{
    <div class="toast-container">
        <div class="alert alert-success copy-success-alert" role="alert">
            <i class="fa fa-check-circle mr-2" aria-hidden="true"></i>
            Link copied to clipboard!
        </div>
    </div>
}

@code
{

    // Search term entered by user for filtering products
    public string SearchTerm = string.Empty;

    // Selected product type filter value
    string SelectedProductType = string.Empty;

    // Selected brand filter value
    string SelectedBrand = string.Empty;

    // Minimum rating filter value
    int MinRating = 0;

    // Sort order selection
    string SortBy = string.Empty;

    // Currently selected product for modal display
    ProductModel SelectedProduct;

    // ID of the selected product
    string SelectedProductId;

    // Current average rating of selected product
    int CurrentRating = 0;

    // Total number of votes for selected product
    int VoteCount = 0;

    // Label text for vote count display
    string VoteLabel;

    // Text of the new comment being added
    string NewComment = string.Empty;

    // Flag to show copy success toast notification
    public bool ShowCopyToast = false;

    /// <summary>
    /// Clears only the search field
    /// </summary>
    public void ClearSearch()
    {
        // Reset search term only
        SearchTerm = string.Empty;
    }

    /// <summary>
    /// Lifecycle method that runs after component renders
    /// </summary>
    /// <param name="firstRender">True if this is the first render</param>
    /// <returns>Task representing async operation</returns>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        // Fast fail: Only process on first render
        if (firstRender == false)
        {
            return;
        }

        // Attempt to open product from URL
        await OpenProductFromUrl();

    }

    /// <summary>
    /// Returns filtered and sorted product list based on current filter criteria
    /// </summary>
    IEnumerable<ProductModel> CurrentProductList
    {
        get
        {

            // Get all products from service
            var products = ProductService.GetProducts();

            // Apply search filter
            products = ApplySearchFilter(products);

            // Apply product type filter
            products = ApplyProductTypeFilter(products);

            // Apply brand filter
            products = ApplyBrandFilter(products);

            // Apply rating filter
            products = ApplyRatingFilter(products);

            // Apply sorting
            products = ApplySorting(products);

            return products;

        }
    }

    /// <summary>
    /// Gets all ProductType enum values excluding Undefined
    /// </summary>
    /// <returns>Collection of all product types</returns>
    IEnumerable<ProductTypeEnum> GetAllProductTypes()
    {

        // Get all enum values and filter out Undefined
        return Enum.GetValues<ProductTypeEnum>()
            .Where(pt => pt != ProductTypeEnum.Undefined)
            .OrderBy(pt => pt.DisplayName());

    }

    /// <summary>
    /// Gets all unique brands from the product catalog
    /// </summary>
    /// <returns>Collection of unique brand names</returns>
    IEnumerable<string> GetAllBrands()
    {

        // Get all products, extract brands, remove duplicates, and sort
        return ProductService.GetProducts()
            .Select(p => p.Brand)
            .Distinct()
            .OrderBy(b => b);

    }

    /// <summary>
    /// Selects a product and loads its details for modal display
    /// </summary>
    /// <param name="productId">ID of the product to select</param>
    void SelectProduct(string productId)
    {

        // Store the selected product ID
        SelectedProductId = productId;

        // Retrieve the product from service
        SelectedProduct = ProductService.GetProducts().First(x => x.Id == productId);

        // Calculate current rating
        GetCurrentRating();

    }

    /// <summary>
    /// Calculates and updates the current rating for the selected product
    /// </summary>
    void GetCurrentRating()
    {

        // Fast fail: Check if ratings array is null
        if (SelectedProduct.Ratings == null)
        {
            CurrentRating = 0;
            VoteCount = 0;
            return;
        }

        // Count total votes
        VoteCount = SelectedProduct.Ratings.Count();

        // Set appropriate vote label
        VoteLabel = "Vote";

        if (VoteCount > 1)
        {
            VoteLabel = "Votes";
        }

        // Calculate average rating
        CurrentRating = SelectedProduct.Ratings.Sum() / VoteCount;

        System.Console.WriteLine($"Current rating for {SelectedProduct.Id}: {CurrentRating}");

    }

    /// <summary>
    /// Submits a new rating for the selected product
    /// </summary>
    /// <param name="rating">Rating value to submit</param>
    void SubmitRating(int rating)
    {

        System.Console.WriteLine($"Rating received for {SelectedProduct.Id}: {rating}");

        // Add rating to product
        ProductService.AddRating(SelectedProductId, rating);

        // Refresh selected product data
        SelectProduct(SelectedProductId);

    }

    /// <summary>
    /// Clears all filter and search criteria
    /// </summary>
    void ClearFilters()
    {

        // Reset search term
        SearchTerm = string.Empty;

        // Reset product type filter
        SelectedProductType = string.Empty;

        // Reset brand filter
        SelectedBrand = string.Empty;

        // Reset rating filter
        MinRating = 0;

        // Reset sort order
        SortBy = string.Empty;

    }

    /// <summary>
    /// Applies search term filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplySearchFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if search term is empty
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            return products;
        }

        // Filter products by brand name containing search term
        return products.Where(p =>
            p.Brand.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    }

    /// <summary>
    /// Applies product type filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplyProductTypeFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if product type filter is empty
        if (string.IsNullOrWhiteSpace(SelectedProductType))
        {
            return products;
        }

        // Try to parse selected product type
        var parseSuccessful = Enum.TryParse<ProductTypeEnum>(SelectedProductType, out var productTypeEnum);

        // Fast fail: Check if parse was unsuccessful
        if (parseSuccessful == false)
        {
            return products;
        }

        // Filter products by product type
        return products.Where(p => p.ProductType == productTypeEnum);

    }

    /// <summary>
    /// Applies brand filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplyBrandFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if brand filter is empty
        if (string.IsNullOrWhiteSpace(SelectedBrand))
        {
            return products;
        }

        // Filter products by exact brand match
        return products.Where(p =>
            p.Brand.Equals(SelectedBrand, StringComparison.OrdinalIgnoreCase));

    }

    /// <summary>
    /// Applies minimum rating filter to product list
    /// </summary>
    /// <param name="products">Products to filter</param>
    /// <returns>Filtered product list</returns>
    IEnumerable<ProductModel> ApplyRatingFilter(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if no rating filter is applied
        if (MinRating == 0)
        {
            return products;
        }

        // Filter products by minimum average rating
        return products.Where(p =>
        {

            // Fast fail: Check if product has no ratings
            if (p.Ratings == null)
            {
                return false;
            }

            if (p.Ratings.Length == 0)
            {
                return false;
            }

            // Calculate average rating
            var avgRating = p.Ratings.Sum() / p.Ratings.Length;

            // Check if average meets minimum
            return avgRating >= MinRating;

        });

    }

    /// <summary>
    /// Applies sorting to product list based on sort criteria
    /// </summary>
    /// <param name="products">Products to sort</param>
    /// <returns>Sorted product list</returns>
    IEnumerable<ProductModel> ApplySorting(IEnumerable<ProductModel> products)
    {

        // Fast fail: Check if no sorting is selected
        if (string.IsNullOrWhiteSpace(SortBy))
        {
            return products;
        }

        // Fast fail: Check if sorting by Brand A-Z
        if (SortBy == "BrandAZ")
        {
            return products.OrderBy(p => p.Brand);
        }

        // Fast fail: Check if sorting by Brand Z-A
        if (SortBy == "BrandZA")
        {
            return products.OrderByDescending(p => p.Brand);
        }

        // Fast fail: Check if sorting by Rating High to Low
        if (SortBy == "RatingHighLow")
        {
            return products.OrderByDescending(p => GetAverageRating(p));
        }

        // Fast fail: Check if sorting by Rating Low to High
        if (SortBy == "RatingLowHigh")
        {
            return products.OrderBy(p => GetAverageRating(p));
        }

        // Return unsorted if sort option not recognized
        return products;

    }

    /// <summary>
    /// Calculates the average rating for a product
    /// </summary>
    /// <param name="product">Product to calculate rating for</param>
    /// <returns>Average rating or 0 if no ratings exist</returns>
    int GetAverageRating(ProductModel product)
    {

        // Fast fail: Check if ratings is null
        if (product.Ratings == null)
        {
            return 0;
        }

        // Fast fail: Check if ratings array is empty
        if (product.Ratings.Length == 0)
        {
            return 0;
        }

        // Calculate and return average rating
        return product.Ratings.Sum() / product.Ratings.Length;

    }

    /// <summary>
    /// Save comment to the data store
    /// </summary>
    public void AddComment()
    {
        // Fast fail: Check if new comment text is empty
        if (string.IsNullOrWhiteSpace(NewComment))
        {
            return;
        }

        // Input sanitization to avoid cross-site scripting
        InputSanitizationService sanitizationService = new InputSanitizationService();
        NewComment = sanitizationService.SanitizeComment(NewComment);
        NewComment = sanitizationService.RemoveDangerousPatterns(NewComment);

        // Add the new comment to the selected product
        ProductService.AddCommentToProduct(SelectedProductId, new CommentModel() { Comment = NewComment });

        // Refresh the selected product to get the updated comment list
        SelectProduct(SelectedProductId);

        // Hide the new comment input box
        NewComment = "";

        // UI Refresh
        StateHasChanged();

    }

    /// <summary>
    /// Checks for Enter key press to submit comment
    /// </summary>
    /// <param name="e">Keyboard event arguments</param>
    public void UsingEnterKey(KeyboardEventArgs e)
    {
        // Check if Enter key is pressed
        if (e.Key == "Enter")
        {
            // Check if Shift key is not pressed
            if (e.ShiftKey == false)
            {
                // Submit the comment
                AddComment();
            }
        }
    }

    /// <summary>
    /// Checks if the selected product has any comments
    /// </summary>
    /// <returns>True if comments exist, false otherwise</returns>
    bool HasComments()
    {

        // Fast fail: Check if comment list is null
        if (SelectedProduct.CommentList == null)
        {
            return false;
        }

        // Fast fail: Check if comment list is empty
        if (SelectedProduct.CommentList.Any() == false)
        {
            return false;
        }

        return true;

    }

    /// <summary>
    /// Returns HTML where occurrences of the current search term in the provided text are wrapped/highlighted.
    /// Delegates to `StringHighlighter.HighlightMatch` and uses the component's `SearchTerm` as the query.
    /// </summary>
    /// <param name="text">The input text to search and highlight (e.g., product brand).</param>
    /// <returns>HTML string with highlighted matches (safe to render as MarkupString).</returns>
    public string HighlightMatch(string text) => StringHighlighter.HighlightMatch(text, SearchTerm);

    /// <summary>
    /// Checks URL for product parameter and opens modal if present
    /// </summary>
    /// <returns>Task representing async operation</returns>
    public async Task OpenProductFromUrl()
    {

        // Get the current URI
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);

        // Parse query string parameters
        var queryString = System.Web.HttpUtility.ParseQueryString(uri.Query);

        // Extract product ID from query string
        var productId = queryString["product"];

        // Fast fail: No product parameter in URL
        if (string.IsNullOrEmpty(productId))
        {
            return;
        }

        // Check if product exists in data store
        var product = ProductService.GetProducts().FirstOrDefault(p => p.Id == productId);

        // Fast fail: Product not found
        if (product == null)
        {
            return;
        }

        // Select the product to populate modal data
        SelectProduct(productId);

        // Trigger UI update before opening modal
        StateHasChanged();

        // Small delay to ensure DOM is ready
        await Task.Delay(100);

        // Open the modal via JavaScript interop
        await JSRuntime.InvokeVoidAsync("openProductModal");

    }

    /// <summary>
    /// Copies shareable product link to clipboard
    /// </summary>
    /// <returns>Task representing async operation</returns>
    public async Task CopyShareLink()
    {

        // Fast fail: No product selected
        if (SelectedProduct == null)
        {
            return;
        }

        // Build the share URL
        var shareUrl = BuildShareUrl();

        // Copy to clipboard via JavaScript interop
        await JSRuntime.InvokeVoidAsync("copyToClipboard", shareUrl);

        // Show success notification
        await ShowCopyNotification();

    }

    /// <summary>
    /// Builds the shareable URL for the selected product
    /// </summary>
    /// <returns>Complete shareable URL string</returns>
    public string BuildShareUrl()
    {

        // Get the base URI
        var baseUri = NavigationManager.BaseUri;

        // Remove trailing slash if present
        if (baseUri.EndsWith("/"))
        {
            baseUri = baseUri.TrimEnd('/');
        }

        // Construct and return full share URL
        return $"{baseUri}/?product={SelectedProduct.Id}";

    }

    /// <summary>
    /// Shows copy success notification and auto-hides after delay
    /// </summary>
    /// <returns>Task representing async operation</returns>
    public async Task ShowCopyNotification()
    {

        // Show the toast notification
        ShowCopyToast = true;

        // Update UI to show toast
        StateHasChanged();

        // Wait 3 seconds
        await Task.Delay(3000);

        // Hide the toast notification
        ShowCopyToast = false;

        // Update UI to hide toast
        StateHasChanged();

    }

}