@using ContosoCrafts.WebSite.Models
@using ContosoCrafts.WebSite.Services
@using Microsoft.AspNetCore.Components.Web

<div>
    <label class="col-form-label theme-label">@Label</label>

    <textarea value="@InternalValue"
              @oninput="HandleInput"
              class="form-control theme-input mb-2"
              placeholder="@Placeholder"
              maxlength="@MaxLength"
              rows="@Rows"
              name="@Name"></textarea>
    <small class="@GetCharCountClass()">
        @GetCharCount() / @MaxLength characters
    </small>
</div>

@code {

    // Label text displayed above textarea
    [Parameter]
    public string Label { get; set; } = "";

    // Placeholder text shown in empty textarea
    [Parameter]
    public string Placeholder { get; set; } = "";

    // Maximum character length allowed
    [Parameter]
    public int MaxLength { get; set; } = 5000;

    // Number of visible text rows
    [Parameter]
    public int Rows { get; set; } = 10;

    // Name attribute for form submission
    [Parameter]
    public string Name { get; set; } = "";

    // Current value of the textarea
    [Parameter]
    public string Value { get; set; } = "";

    // Event callback when value changes
    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    // Internal value used for binding
    private string _internalValue = string.Empty;
    public string InternalValue
    {
        get => _internalValue;
        set
        {
            // Ensure non-null
            _internalValue = value ?? string.Empty;

            // Notify consumers about change
            // Fire-and-forget is acceptable for EventCallback
            _ = ValueChanged.InvokeAsync(_internalValue);
        }
    }

    /// <summary>
    /// Initializes the component with the initial value
    /// </summary>
    protected override void OnInitialized()
    {

        // Set internal value from parameter
        InternalValue = Value;

        // Fast fail: Check if Value is null
        if (Value == null)
        {
            InternalValue = "";
        }

    }

    /// <summary>
    /// Updates internal value when parameters change
    /// </summary>
    protected override void OnParametersSet()
    {

        // Set internal value from parameter
        InternalValue = Value;

        // Fast fail: Check if Value is null
        if (Value == null)
        {
            InternalValue = "";
        }

    }

    /// <summary>
    /// Handles input event to update value and trigger re-render for character count
    /// </summary>
    /// <param name="args">Change event arguments containing new value</param>
    private void HandleInput(ChangeEventArgs args)
    {
        // Fast fail: Check if args is null
        if (args == null)
        {
            return;
        }

        // Fast fail: Check if value is null
        if (args.Value == null)
        {
            InternalValue = string.Empty;
            return;
        }

        // Update internal value with new input
        InternalValue = args.Value.ToString();
    }

    /// <summary>
    /// Gets the current character count of the textarea
    /// </summary>
    /// <returns>Number of characters</returns>
    public int GetCharCount()
    {

        // Fast fail: Check if internal value is null or empty
        if (string.IsNullOrEmpty(InternalValue))
        {
            return 0;
        }

        // Return length of internal value
        return InternalValue.Length;

    }

    /// <summary>
    /// Gets the CSS class for character count display
    /// </summary>
    /// <returns>CSS class string</returns>
    public string GetCharCountClass()
    {

        // Get current character count
        int count = GetCharCount();

        // Fast fail: Check if at or exceeding limit
        if (count >= MaxLength)
        {
            return "text-danger";
        }

        // Under limit
        return "text-muted theme-text-muted";

    }

}